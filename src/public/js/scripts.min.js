const URL="http://192.168.0.10:3333/api",search=(()=>{const e=()=>new Promise((e,t)=>{fetch("https://ipapi.co/json/",{method:"GET",headers:{"content-type":"application/json"}}).then(e=>e.ok?e.json():t("Erro ao pesquisar codigo")).then(t=>e(t)).catch(e=>t(e))}),t=e=>new Promise((t,r)=>{const{code:o,ip:n,city:a,region:s}=e;fetch("/api/search",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({code:o,ip:n,city:a,region:s})}).then(e=>e.json()).then(e=>(console.log(e),e.error?r(e.error):t(e))).catch(e=>r(e))});return{search:r=>{r.addEventListener("click",o=>{o.preventDefault(),console.log();const n=r.closest("form").querySelector("input.Code");return e().then(e=>{const{ip:r,city:o,region:a}=e;return t({code:n.value,ip:r,city:o,region:a}).then(e=>{const{device:t,code:r,ip:o,city:n,region:a,product:s,item:c}=e,i=document.querySelector(".clientInfo");return console.log(e),i.innerHTML=`\n                        <p>\n                            <strong>Código: </strong> ${r}\n                        </p>\n                        <p>\n                            <strong>Produto: </strong> ${s.name}\n                        </p>\n                        <p>\n                            <strong>Item: </strong> ${c.name}\n                        </p>\n                        <p>\n                            <strong>Device: </strong> ${t}\n                        </p>\n                        <p>\n                            <strong>Cidade: </strong> ${n}\n                        </p>\n                        <p>\n                            <strong>Estado: </strong> ${a}\n                        </p>\n                        <p>\n                            <strong>Endereço IP: </strong> ${o}\n                        </p>\n                    `}).catch(e=>Swal.fire({title:e,icon:"error",confirmButtonText:"Ok"}))})})}}})(),btnSearchCode=document.querySelector(".btnSearchCode");btnSearchCode&&search.search(btnSearchCode);const btnsProduct=document.querySelectorAll(".productDelete"),requestDeleteProduct=e=>new Promise((t,r)=>{const o=document.body.dataset.token;fetch(`/api/product/${e}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${o}`}}).then(e=>e.json()).then(e=>e.error?r(e.error):t(e)).catch(e=>r(e))});btnsProduct&&Array.from(btnsProduct).forEach(e=>{e.addEventListener("click",t=>{const r=e.dataset.product;requestDeleteProduct(r).then(t=>(e.closest(".col-12").remove(),Swal.fire({title:"Produto excluido com sucesso!",text:`O produto ${t.name} foi excluído`,icon:"success",confirmButtonText:"Ok"}))).catch(e=>Swal.fire({title:"Arro ao remover produto",text:e,icon:"error",confirmButtonText:"Ok"}))})});const productResource="product";let codesInsert=[],productImages=[];const clearListItems=()=>{codesInsert=[];const e=document.querySelectorAll(".colapseCodes > div > .row > div");if(e)return Array.from(e).forEach(e=>{if(e)return e.remove()}),document.querySelector(".headerListItem span.badge,badge-primary").innerHTML=codesInsert.length},putSpinnet=(e,t)=>{const r=document.createElement("div");return r.classList.add("spinner-border","text-primary","float-right"),r.setAttribute("role","status"),r.innerHTML='<span class="sr-only">Loading...</span>',"insert"===t?e.append(r):"remove"===t&&e.querySelector(".spinner-border")?e.querySelector(".spinner-border").remove():void 0},changeBadgeForm=e=>{const t=document.querySelector(".colapseCodes"),r=t.closest(".accordion").querySelector(".card-header .badge");if(t)return r.innerHTML=e},removeCodeForm=e=>{e.addEventListener("click",t=>{const r=e.dataset.code,o=codesInsert.find(e=>e.code===r);if(o){let t=codesInsert.indexOf(o);return codesInsert.splice(t,1),e.closest(".col-12").remove(),changeBadgeForm(codesInsert.length)}console.log("código não esta presente")})},checkCodeInList=e=>!codesInsert.find(t=>t.code===e),createItem=e=>{const{prefix:t,code:r}=e,o=document.createElement("div");return o.classList.add("col-12","mb-3"),o.innerHTML=`\n    <div class="card">\n        <div class="card-header">\n            ${t}\n            <button type="button" class="float-right btn btn-danger btn-sm" data-code="${r}"><i class="fas fa-trash-alt"></i></button>\n        </div>\n        <div class="card-body">\n        ${r}\n        </div>\n    </div>\n    `,removeCodeForm(o.querySelector("button")),o},formValidate=e=>new Promise((t,r)=>{if("object"!=typeof e)return r("O parametro deve ser um array");const o=e.filter(e=>{if(!e.value)return e});return t({valids:e.filter(e=>{if(e.value)return e}),invalids:o})}),insertSingleCode=e=>{e.addEventListener("click",t=>{if(t.preventDefault(),e.disabled)return!1;const r=e.closest("form");putSpinnet(r,"insert");const o=r.querySelector(".productItemName"),n=r.querySelector(".productCode");return formValidate([o,n]).then(e=>{const{valids:t,invalids:a}=e;if(a.length)return a.map(e=>{e.classList.remove("is-valid"),e.classList.add("is-invalid")});if(!checkCodeInList(n.value))return putSpinnet(r,"remove"),Swal.fire({title:"O Código duplicado",text:`O Código ${n.value} já está cadastrado em um item`,icon:"error",confirmButtonText:"Ok"});codesInsert.push({code:n.value,name:o.value});const s=createItem({prefix:o.value,code:n.value}),c=document.querySelector(".colapseCodes");return c?(c.querySelector(".card-body > .row").append(s),changeBadgeForm(codesInsert.length),putSpinnet(r,"remove"),c.classList.add("show")):void 0})})},changeFileProduct=e=>{e.addEventListener("change",t=>{const r=e.value.split(/(\\|\/)/g).pop();e.closest(".custom-file").querySelector("label").innerHTML=r;const o=document.querySelector(".productItemName");return putSpinnet(o.closest("form"),"insert"),formValidate([o]).then(t=>{const{invalids:r,valids:n}=t;return r.length?(putSpinnet(o.closest("form"),"remove"),e.value="",r.map(e=>{e.classList.remove("is-valid"),e.classList.add("is-invalid")})):readFile(e.files[0]).then(e=>{const r=document.querySelector(".colapseCodes");r&&r.classList.add("show");const{invalids:n,valids:a}=t;return a.map(e=>{e.classList.remove("is-invalid"),e.classList.add("is-valid")}),e.map(e=>{const t=createItem({prefix:o.value,code:e.text});if(!checkCodeInList(e.text))return putSpinnet(o.closest("form"),"remove"),Swal.fire({title:"O Código duplicado",text:`O Código ${e.text} já está cadastrado em um item`,icon:"error",confirmButtonText:"Ok"});codesInsert.push({code:e.text,name:o.value}),changeBadgeForm(codesInsert.length),r.querySelector(".card-body > .row").append(t)}),putSpinnet(o.closest("form"),"remove")}).catch(e=>(putSpinnet(o.closest("form"),"remove"),Swal.fire({title:e,icon:"error",confirmButtonText:"Ok"})))})})},readFile=e=>new Promise((t,r)=>{const o=document.body.dataset.token,n=new FormData;n.append("file",e);const{type:a}=e;if("text/plain"!=a)return r("O tipo de arquivo deve ser .txt"),Swal.fire({title:"O tipo de arquivo deve ser .txt",text:"Selecione um arquivo com extensão txt",icon:"error",confirmButtonText:"Ok"});fetch("/api/file",{method:"POST",headers:{authorization:`Bearer ${o}`},body:n}).then(e=>e.json()).then(e=>e.error?r(e.error):t(e)).catch(e=>r(e))}),requestInsertProduct=e=>new Promise((t,r)=>{const{name:o,description:n,weight:a,brand:s,lot:c,type:i,availability:d,items:l,image_id:u,category_id:m}=e,p=document.body.dataset.token;fetch("/api/product",{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${p}`},body:JSON.stringify({name:o,description:n,weight:a,brand:s,lot:c,type:i,category_id:m,availability:d,items:l,image_id:u})}).then(e=>e.json()).then(e=>e.error?r(e.error.replace(/(\r\n|\n|\r)/gm,"<br>")):(t(e),console.log(e))).catch(e=>r(e))}),imageProductApi=e=>new Promise((t,r)=>{const o=document.body.dataset.token,n=new FormData;n.append("file",e);fetch("/api/image/product",{method:"POST",headers:{authorization:`Bearer ${o}`},body:n}).then(e=>e.json()).then(e=>e.error?r(e.error):t(e)).catch(e=>r(e))}),imageProductChange=e=>{e.addEventListener("change",t=>{t.preventDefault(),putSpinnet(e.closest("form"),"insert");const r=e.value.split(/(\\|\/)/g).pop(),o=document.querySelector(".imagesProductContainer");return e.closest(".custom-file").querySelector("label").innerHTML=r,console.log(e.files[0]),imageProductApi(e.files[0]).then(t=>{const r=document.querySelector(".idProductImage");putSpinnet(e.closest("form"),"remove"),r&&(r.value=t.id);const n=document.createElement("img");return n.setAttribute("src",t.url),n.setAttribute("width",150),n.classList.add("img-thumbnail","mx-2"),o.append(n),0===productImages.length?productImages.push({id:t.id,default:!0}):productImages.push({id:t.id,default:!1})}).catch(t=>{putSpinnet(e.closest("form"),"remove"),console.log(t)})})},productCreate=e=>{const t=e.querySelector(".productName"),r=e.querySelector(".productDescription"),o=e.querySelector(".productWeigth"),n=e.querySelector(".productBrand"),a=e.querySelector(".productLot"),s=e.querySelector(".productType"),c=e.querySelector(".productAvailability"),i=document.querySelector(".productItemName"),d=document.querySelector(".multCodes"),l=document.querySelector(".productCode"),u=document.querySelector(".fileToRead"),m=productImages,p=e.querySelector(".productCategory");e.classList.add("was-validated"),putSpinnet(e.closest("form"),"insert");const v=[t,o,n,a,s,c,i,p];return d.checked?v.push(u):v.push(l),formValidate(v).then(i=>{const{valids:d,invalids:l}=i;return l.length&&(putSpinnet(e.closest("form"),"remove"),l.forEach(e=>{e.classList.remove("is-valid"),e.classList.add("is-invalid")})),codesInsert.length?(d.forEach(e=>{e.classList.remove("is-invalid"),e.classList.add("is-valid")}),requestInsertProduct({name:t.value,description:r.value,weight:o.value,brand:n.value,lot:a.value,type:s.value,availability:c.value,items:codesInsert,category_id:p.value,image_id:m}).then(t=>{if(t.error){const r=document.createElement("div");r.classList.add("alert","alert-danger"),r.setAttribute("role","alert"),r.innerHTML=t.error,e.prepend(r),setTimeout(()=>{r.remove()},4e3)}const r=e.querySelectorAll("input, textarea, .is-valid");return e.classList.remove("was-validated"),Array.from(r).forEach(e=>(e.value="",e.classList.remove("is-valid"))),putSpinnet(e.closest("form"),"remove"),Swal.fire({title:"Produto cadastrado",text:`O produto ${t.name} foi cadastrado com sucesso`,icon:"success",confirmButtonText:"Ok"})}).catch(t=>{const r=document.createElement("div");r.classList.add("alert","alert-danger"),r.setAttribute("role","alert"),r.innerHTML=t,e.prepend(r),putSpinnet(e.closest("form"),"remove"),setTimeout(()=>{r.remove()},4e3)})):Swal.fire({title:"Nenhum item cadastrado",text:"Por favor ensira ao menos 1 item no produto",icon:"error",confirmButtonText:"Ok"})}).catch(e=>{console.log(e)})},btnInsertProduct=document.querySelector(".btnInsertProduct");btnInsertProduct&&btnInsertProduct.addEventListener("click",e=>{e.preventDefault(),productCreate(btnInsertProduct.closest("form"))});const switchMultCodes=document.querySelector(".multCodes");switchMultCodes&&switchMultCodes.addEventListener("change",function(e){!0===switchMultCodes.checked?(document.querySelector(".form-items-codes .custom-file-wrapper").classList.add("show"),document.querySelector(".form-items-codes .singleCode").classList.add("hide"),document.querySelector(".btnInsertItemProduct").disabled=!0):(document.querySelector(".form-items-codes .custom-file-wrapper").classList.remove("show"),document.querySelector(".form-items-codes .singleCode").classList.remove("hide"),document.querySelector(".btnInsertItemProduct").disabled=!1)}),btnClearCodes=document.querySelector(".btnCleamListProduct"),btnClearCodes&&btnClearCodes.addEventListener("click",e=>(e.preventDefault(),clearListItems()));const inputFileProduct=document.querySelector(".fileToRead");inputFileProduct&&changeFileProduct(inputFileProduct);const btnInsertItemProduct=document.querySelector(".btnInsertItemProduct");btnInsertItemProduct&&insertSingleCode(btnInsertItemProduct);const ImageProduct=document.querySelector(".productImage");ImageProduct&&imageProductChange(ImageProduct);const loginResource="login",requestLogin=e=>new Promise((t,r)=>{const{email:o,password:n}=e;fetch("/api/login",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({email:o,password:n})}).then(e=>e.json()).then(e=>e.error?r(e.error):(t(e),console.log(e))).catch(e=>r(e))}),login=e=>{const t=e.querySelector(".loginMail"),r=e.querySelector(".loginPassword");return e.classList.add("was-validated"),t.value?(t.classList.remove("is-invalid"),t.classList.add("is-valid"),r.value?requestLogin({email:t.value,password:r.value}).then(e=>{window.location.href="/dashboard"}).catch(t=>{const r=document.createElement("div");r.classList.add("alert","alert-danger"),r.setAttribute("role","alert"),r.innerHTML=t,e.prepend(r),setTimeout(()=>{r.remove()},4e3)}):r.classList.add("is-invalid")):t.classList.add("is-invalid")},btnLogin=document.querySelector(".btnLogin");btnLogin&&btnLogin.addEventListener("click",e=>{e.preventDefault(),login(btnLogin.closest("form"))});const category=(()=>{const e=$("#dataTable").DataTable(),t=(t,o)=>{r(o).then(r=>(e.row($(t.closest("tr"))).remove().draw(),Swal.fire({title:`Categoria ${r.name} removida com sucesso!`,icon:"success",confirmButtonText:"Ok"}))).catch(e=>Swal.fire({title:e,text:"Ocorreu um erro ao remover a categoria",icon:"error",confirmButtonText:"Ok"}))},r=e=>new Promise((t,r)=>{const o=document.body.dataset.token;fetch(`/api/category/${e}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${o}`}}).then(e=>e.ok?e.json():r("Erro ao deletar categoria")).then(e=>t(e)).catch(e=>r(e))}),o=e=>(e=>{const r=e.dataset.id;e.addEventListener("click",o=>(o.preventDefault(),t(e,r)))})(e),n=t=>{t.addEventListener("click",r=>{const o=t.dataset.id,n=document.querySelector(".btnEditCategory");return(e=>new Promise((t,r)=>{const o=document.body.dataset.token;fetch(`/api/category/${e}`,{method:"GET",headers:{"content-type":"application/json",authorization:`Bearer ${o}`}}).then(e=>e.json()).then(e=>t(e)).catch(e=>r(e))}))(o).then(t=>{const r=document.querySelector(".editCategoryName"),o=document.querySelector(".editCategoryDescription"),a=document.querySelector(".editCategorySlug"),s=document.querySelector(".editCategoryParent"),{id:c,name:i,description:d,slug:l,parent:u}=t;return s.querySelector(`option[value="${u}"]`)&&(s.querySelector(`option[value="${u}"]`).selected=!0),r.value=i,o.value=d,a.value=l,n.addEventListener("click",t=>(e=>new Promise((t,r)=>{const o=document.body.dataset.token,{id:n,name:a,description:s,slug:c,parent:i}=e;fetch(`/api/category/${n}`,{method:"PUT",headers:{"content-type":"application/json",authorization:`Bearer ${o}`},body:JSON.stringify({name:a,description:s,slug:c,parent:i})}).then(e=>e.ok?e.json():r("Erro ao criar categoria")).then(e=>t(e)).catch(e=>r(e))}))({id:c,name:r.value,description:o.value,slug:a.value,parent:s.value||null}).then(t=>(t=>{const{id:r,name:o,description:n,slug:a,parent:s,createdAt:c}=t,i=document.querySelector(`.category-${r}`);if(i){i.querySelector("td:nth-child(2)"),i.querySelector("td:nth-child(3)"),i.querySelector("td:nth-child(5)");let t=new Date(c);t=new Intl.DateTimeFormat("pt-BR").format(t);let r=e.row($(i)).data();return console.log(i),r[1]=o,r[2]=n,r[4]=t,e.row($(i)).data(r).draw(),Swal.fire({title:`Categoria ${o} editada com sucesso!`,icon:"success",confirmButtonText:"Ok"})}})(t)))}).catch(e=>Swal.fire({title:"Erro ao editar categoria",icon:"error",confirmButtonText:"Ok"}))})};return{destroy:o,create:t=>{t.addEventListener("click",t=>{t.preventDefault();const r=document.querySelector(".categoryName"),a=document.querySelector(".categoryDescription"),s=document.querySelector(".categorySlug"),c=document.querySelector(".categoryParent");return(e=>new Promise((t,r)=>{e.map(e=>{const{input:o,msg:n}=e;return console.log(),o.value&&"Selecione..."!=o.value?t():(o.setCustomValidity(n),o.reportValidity(),r(n))})}))([{input:r,msg:"Informe um nome para a categoria"}]).then(()=>(e=>new Promise((t,r)=>{const o=document.body.dataset.token,{name:n,description:a,slug:s,parent:c}=e;fetch("/api/category",{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${o}`},body:JSON.stringify({name:n,description:a,slug:s,parent:c})}).then(e=>e.ok?e.json():r("Erro ao criar categoria")).then(e=>t(e)).catch(e=>r(e))}))({name:r.value,description:a.value,slug:s.value,parent:c.value||null}).then(t=>((t=>{const{id:r,name:a,description:s,createdAt:c}=t;let i=new Date(c);i=new Intl.DateTimeFormat("pt-BR").format(i);const d=e.row.add([r,a,s,0,i,`\x3c!-- Botão de ação Editar // --\x3e\n            <button type="button" class="btn btn-datatable btn-icon btn-transparent-dark editCategory py-0" data-toggle="modal" data-target="#modalEditCategory" data-id="${r}">\n                <i class="fas fa-edit"></i>\n            </button>\n            \x3c!-- Botão de ação Editar // --\x3e\n            <button type="button" class="btn btn-datatable btn-icon btn-transparent-dark categoryDestroy py-0" data-id="${r}">\n                <i class="far fa-trash-alt"></i>\n            </button>`]).draw().node();d.classList.add(`category-${r}`);const l=d.querySelector(".editCategory");n(l);const u=d.querySelector(".categoryDestroy");o(u)})(t),Swal.fire({title:`Categoria ${t.name} criada com sucesso!`,icon:"success",confirmButtonText:"Ok"}))).catch(e=>Swal.fire({title:e,icon:"error",confirmButtonText:"Ok"}))).catch(e=>console.log(e))})},edit:n}})(),btnCategoryDestroy=document.querySelectorAll(".categoryDestroy");btnCategoryDestroy&&Array.from(btnCategoryDestroy).forEach(e=>category.destroy(e));const btnModalEditCategory=document.querySelectorAll(".editCategory");btnModalEditCategory&&Array.from(btnModalEditCategory).forEach(e=>category.edit(e));const btnCreateCategory=document.querySelector(".btnCreateCategory");btnCreateCategory&&category.create(btnCreateCategory);const userResource="user",requestInsertAvatar=e=>new Promise((t,r)=>{const o=document.body.dataset.token,n=new FormData;n.append("file",e);fetch("/api/user/image",{method:"POST",headers:{authorization:`Bearer ${o}`},body:n}).then(e=>e.json()).then(e=>(console.log(e),t(e)))}),requestInsertUser=e=>new Promise((t,r)=>{const{name:o,email:n,password:a,phone:s,cell:c,type:i,image_id:d}=e,l=document.body.dataset.token;fetch("/api/user",{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${l}`},body:JSON.stringify({name:o,email:n,password:a,phone:s,cell:c,type:i,image_id:d})}).then(e=>e.json()).then(e=>e.error?r(e.error):(t(e),console.log(e))).catch(e=>r(e))}),userCreate=e=>{const t=e.querySelector("input.userName"),r=e.querySelector(".userMail"),o=e.querySelector(".userPhone"),n=e.querySelector(".userCell"),a=e.querySelector(".userType"),s=e.querySelector(".userPassword"),c=e.querySelector(".inputUserImage");return e.classList.add("was-validated"),t.value?(t.classList.remove("is-invalid"),t.classList.add("is-valid"),r.value?(r.classList.remove("is-invalid"),r.classList.add("is-valid"),o.value?(o.classList.remove("is-invalid"),o.classList.add("is-valid"),n.value?(n.classList.remove("is-invalid"),n.classList.add("is-valid"),s.value?(s.classList.remove("is-invalid"),s.classList.add("is-valid"),a.value?(a.classList.remove("is-invalid"),a.classList.add("is-valid"),requestInsertUser({name:t.value,email:r.value,phone:o.value,cell:n.value,type:a.value,password:s.value,image_id:c.value}).then(t=>{if(t.error){const r=document.createElement("div");r.classList.add("alert","alert-danger"),r.setAttribute("role","alert"),r.innerHTML=t.error,e.prepend(r),setTimeout(()=>{r.remove()},4e3)}const r=e.querySelectorAll("input, textarea, .is-valid");return e.classList.remove("was-validated"),Array.from(r).forEach(e=>(e.value="",e.classList.remove("is-valid"))),alert(`Usuário ${t.name} cadastrado!`)}).catch(t=>{const r=document.createElement("div");r.classList.add("alert","alert-danger"),r.setAttribute("role","alert"),r.innerHTML=t,e.prepend(r),setTimeout(()=>{r.remove()},4e3)})):a.classList.add("is-invalid")):s.classList.add("is-invalid")):n.classList.add("is-invalid")):o.classList.add("is-invalid")):r.classList.add("is-invalid")):t.classList.add("is-invalid")},inputImageUser=document.querySelector(".userFile");inputImageUser&&inputImageUser.addEventListener("change",e=>(console.log(inputImageUser.files[0]),requestInsertAvatar(inputImageUser.files[0]).then(e=>{document.querySelector(".insertUserAvatar").setAttribute("src",e.url),document.querySelector(".inputUserImage").value=e.id})));const btnInsertUser=document.querySelector(".btnCreateUser");btnInsertUser&&btnInsertUser.addEventListener("click",e=>{e.preventDefault(),userCreate(btnInsertUser.closest("form"))});